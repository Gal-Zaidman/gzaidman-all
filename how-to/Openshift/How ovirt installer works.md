# How ovirt installer works

The perpuse of this doc is to provide all the information on how the ocp on ovirt installer works.

## Bootstrap machine

Is a temporary VM that starts when the installation begins and is destroyed during the installation process. In Openshift every machine boots with a configuration which references resources hosted in the cluster it is joining (TODO: what are the resources in ovirt) but since there is no cluster before the installation we need a temporary machine so all the masters that are created can reference the required resources - this is the job of the bootstrap machine. The bootstrap machine is booted with a concrete Ignition Config which describes how to create the cluster.
The Bootstrap machine acts as a temporary control plane whose sole purpose is launching the rest of the cluster.

## The process for bootstrapping a cluster looks like the following:

1. The bootstrap machine boots and starts hosting the remote resources required for the master machines to boot.
2. The master machines fetch the remote resources from the bootstrap machine and finish booting.
3. The master machines use the bootstrap node to form an etcd cluster.
4. The bootstrap node starts a temporary Kubernetes control plane using the newly-created etcd cluster.
5. The temporary control plane schedules the production control plane to the master machines.
6. The bootstrap node injects OpenShift-specific components via the temporary control plane.
7. The temporary control plane shuts down, leaving just the production control plane.
8. The installer tears down the bootstrap node.

The result of this bootstrapping process is a fully running OpenShift cluster. The cluster will then download and configure remaining components needed for the day-to-day operation, including the creation of worker machines in supported platforms.

## Key Concepts

### Targets

There are two modes of operation in the installer, create and destroy, which are invoked by running:
`openshift-install [create, destroy]`

The following targets can be created:

- `install-config` - The install config contains the main parameters for the installation process. This configuration provides the user with more options than the interactive prompts and comes pre-populated with default values.
- `manifests` - This target outputs all of the Kubernetes manifests that will be installed on the cluster.
- `ignition-configs` - These are the three Ignition Configs for the bootstrap, master, and worker machines.
- `cluster` - This target provisions the cluster and its associated infrastructure.

The following targets can be destroyed:

- `cluster` - This destroys the created cluster and its associated infrastructure.
- `bootstrap` - This destroys the bootstrap infrastructure.

### Multiple Invocations

In order to allow users to [customize their installation](customization.md), the installer can be invoked multiple times. The state is stored in a hidden file in the asset directory and contains all of the intermediate artifacts. This allows the installer to pause during the installation and wait for the user to modify intermediate artifacts.

For example, you can create an install config and save it in a cluster-agnostic location:

```sh
openshift-install --dir=initial create install-config
mv initial/install-config.yaml .
rm -rf initial
```

You can use the saved install-config for future clusters by copying it into the asset directory and then invoking the installer:

```sh
mkdir cluster-0
cp install-config.yaml cluster-0/
openshift-install --dir=cluster-0 create cluster
```

Supplying a previously-generated install-config like this is explicitly part of the stable installer API.
Note that the installer would consume `install-config.yaml` from the asset directory.
At any point before running `destroy cluster`, `install-config.yaml` can be regenerated by running `openshift-install --dir=cluster-0 create install-config`.

You can also edit the assets in the asset directory during a single run.
For example, you can adjust [the cluster-version operator's configuration][cluster-version]:

```sh
mkdir cluster-1
cp install-config.yaml cluster-1/
openshift-install --dir=cluster-1 create manifests  # warning: this target is unstable
"${EDITOR}" cluster-1/manifests/cvo-overrides.yaml
openshift-install --dir=cluster-1 create cluster
```

As the unstable warning suggests, the presence of `manifests` and the names and content of its output is an unstable installer API.
It is occasionally useful to make alterations like this as one-off changes, but don't expect them to work on subsequent installer releases.

[cluster-version]: https://github.com/openshift/cluster-version-operator/blob/master/docs/dev/clusterversion.md
